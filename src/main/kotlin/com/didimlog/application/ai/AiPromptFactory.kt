package com.didimlog.application.ai

import com.didimlog.infra.ai.PromptTemplateLoader
import com.didimlog.infra.util.HtmlTextExtractor
import org.springframework.stereotype.Component

@Component
class AiPromptFactory(
    private val templateLoader: PromptTemplateLoader
) {

    /**
     * í’€ì´ ì„±ê³µ ì—¬ë¶€ì— ë”°ë¼ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
     * ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼ ì ì ˆí•œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ íŒŒì¼ì„ ë¡œë“œí•œë‹¤.
     *
     * @param isSuccess í’€ì´ ì„±ê³µ ì—¬ë¶€
     * @return ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¬¸ìžì—´
     */
    fun createSystemPrompt(isSuccess: Boolean): String {
        if (isSuccess) {
            return templateLoader.loadTemplate("success-retrospective.md")
        }
        return templateLoader.loadTemplate("failure-retrospective.md")
    }

    /**
     * ì‚¬ìš©ìž í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
     * ë¬¸ì œ ì •ë³´ì™€ ì‚¬ìš©ìž ì½”ë“œë¥¼ í¬í•¨í•œ ìž…ë ¥ ë°ì´í„°ë¥¼ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±í•œë‹¤.
     *
     * @param problemId ë¬¸ì œ ID
     * @param problemTitle ë¬¸ì œ ì œëª©
     * @param problemDescription ë¬¸ì œ ë³¸ë¬¸ HTML (nullable)
     * @param code ì‚¬ìš©ìž ì½”ë“œ
     * @param isSuccess í’€ì´ ì„±ê³µ ì—¬ë¶€
     * @return ì‚¬ìš©ìž í”„ë¡¬í”„íŠ¸ ë¬¸ìžì—´
     */
    fun createUserPrompt(
        problemId: String,
        problemTitle: String,
        problemDescription: String?,
        code: String,
        isSuccess: Boolean
    ): String {
        val descriptionText = HtmlTextExtractor.extractText(problemDescription) ?: "ë¬¸ì œ ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        val isSuccessText = when (isSuccess) {
            true -> "true"
            false -> "false"
        }

        return """
        # Input Data
        - ë¬¸ì œ ë²ˆí˜¸: $problemId
        - ë¬¸ì œ ì œëª©: $problemTitle
        - ë¬¸ì œ ë³¸ë¬¸(HTML/Text): $descriptionText
        - í’€ì´ ê²°ê³¼: $isSuccessText
        - ì‚¬ìš©ìž ì½”ë“œ:
        $code

        # Instruction
        1. **ë¬¸ì œ ì„¤ëª… ìš”ì•½:** ì œê³µëœ ë¬¸ì œ ë³¸ë¬¸ì„ ì½ê³ , ì–´ë–¤ ë¬¸ì œì¸ì§€ 1~2ë¬¸ìž¥ìœ¼ë¡œ í•µì‹¬ë§Œ ìš”ì•½í•´ë¼.
        2. **ë¶„ì„:**
           - (ì„±ê³µ ì‹œ): íš¨ìœ¨ì„±(ì‹œê°„/ê³µê°„ ë³µìž¡ë„)ê³¼ ìž˜í•œ ì (ì•Œê³ ë¦¬ì¦˜ ì„ íƒ ë“±)ì„ ì¹­ì°¬í•´ë¼.
           - (ì‹¤íŒ¨ ì‹œ): ì‹¤íŒ¨ ì›ì¸ì„ ë¶„ì„í•˜ê³ , ì •ë‹µ ëŒ€ì‹  í•™ìŠµí•´ì•¼ í•  í‚¤ì›Œë“œë¥¼ ì œì‹œí•´ë¼.
        3. **ë‚´ ì½”ë“œ í¬í•¨:** ì‚¬ìš©ìžì˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ ê°ì‹¸ì„œ ì¶œë ¥í•´ë¼.
        4. **í˜•ì‹ ì¤€ìˆ˜:** ì•„ëž˜ [Output Format]ì„ ê·¸ëŒ€ë¡œ ë”°ë¥¼ ê²ƒ.

        # Output Format
        # [$problemId] $problemTitle

        ## ðŸ“ ë¬¸ì œ ì„¤ëª…
        (ì—¬ê¸°ì— ë¬¸ì œë¥¼ 1~2ë¬¸ìž¥ìœ¼ë¡œ ìš”ì•½í•˜ì—¬ ìž‘ì„±)

        ## ðŸ’» ë‚˜ì˜ í’€ì´
        ```java
        $code
        ```
        *(ì–¸ì–´ëŠ” ì½”ë“œì— ë§žì¶° ì ì ˆížˆ ê°ì§€)*

        ## ðŸ’¡ í•µì‹¬ ë¶„ì„ (Key Analysis)
        (ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì— ë”°ë¥¸ ë¶„ì„ ë‚´ìš© 3~4ë¬¸ìž¥)

        ## ðŸš€ ê°œì„ ì  ë° íŒ
        (ë¦¬íŒ©í† ë§ ì œì•ˆì´ë‚˜ í•™ìŠµ ížŒíŠ¸ë¥¼ ë¶ˆë › í¬ì¸íŠ¸ë¡œ ìž‘ì„±)
        - 
        - 

        ---
        > _Generated by DidimLog_
        """.trimIndent()
    }
}
