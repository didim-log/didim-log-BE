name: didim-log-be Deploy CICD

# Required GitHub Secrets:
# === Docker Hub 설정 ===
# - DOCKER_USERNAME: Docker Hub 사용자명
# - DOCKER_PASSWORD: Docker Hub 비밀번호
# - DOCKER_REPONAME: Docker Hub 저장소 이름
#
# === AWS EC2 설정 ===
# - AWS_HOST: EC2 인스턴스 호스트 주소
# - AWS_USER: EC2 SSH 사용자명
# - AWS_EC2_PRIVATE_KEY: EC2 SSH 개인 키
#
# === 데이터베이스 연결 설정 ===
# - SPRING_DATA_MONGODB_URI: MongoDB 연결 URI
# - SPRING_DATA_REDIS_HOST: Redis 호스트 (docker-compose service name: 'redis')
# - SPRING_DATA_REDIS_PORT: Redis 포트
#
# === 서버 설정 ===
# - SERVER_URL: 서버 URL (예: https://api.your-domain.com)
#
# === JWT 토큰 설정 ===
# - JWT_SECRET: JWT 토큰 서명용 시크릿 키 (강력한 랜덤 문자열 필수)
#
# === CORS 설정 ===
# - ALLOWED_ORIGINS: CORS 허용 Origin 목록 (쉼표로 구분, 예: https://your-frontend-domain.com,https://www.your-frontend-domain.com)
#
# === OAuth2 설정 ===
# - OAUTH_GOOGLE_ID: Google OAuth2 Client ID
# - OAUTH_GOOGLE_SECRET: Google OAuth2 Client Secret
# - OAUTH_GITHUB_ID: GitHub OAuth2 Client ID
# - OAUTH_GITHUB_SECRET: GitHub OAuth2 Client Secret
# - OAUTH_NAVER_ID: Naver OAuth2 Client ID
# - OAUTH_NAVER_SECRET: Naver OAuth2 Client Secret
# - OAUTH_REDIRECT_URI: OAuth2 인증 후 프론트엔드 리다이렉트 URI
#
# === 관리자 설정 ===
# - ADMIN_SECRET_KEY: 슈퍼 관리자 계정 생성용 보안 키
#
# === 이메일 발송 설정 ===
# - MAIL_USERNAME: SMTP 이메일 발송 계정 (기본값: didimlognoreply@gmail.com)
# - MAIL_PASSWORD: SMTP 이메일 발송 앱 비밀번호 (Gmail 앱 비밀번호 필수)
#
# === Swagger UI 설정 ===
# - SWAGGER_USERNAME: Swagger UI 접근용 HTTP Basic Authentication 사용자명 (기본값: admin)
# - SWAGGER_PASSWORD: Swagger UI 접근용 HTTP Basic Authentication 비밀번호 (프로덕션에서는 강력한 비밀번호 필수)
#
# === AI 서비스 설정 (선택사항) ===
# - GEMINI_API_KEY: Gemini API Key
# - GEMINI_API_URL: Gemini API URL (generateContent endpoint, 기본값 제공)

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'DOCS/**'
      - 'SECRET_DOCS/**'
      - '.gitignore'
      - '.cursorrules'
      - '*.md'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build with Gradle Wrapper
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_API_URL: ${{ secrets.GEMINI_API_URL }}
        run: ./gradlew clean assemble

      - name: Build Dockerfile and Push DockerHub
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker build -f Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPONAME }}:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPONAME }}:latest

      - name: Create deployment directory on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          script: |
            mkdir -p /home/${{ secrets.AWS_USER }}/app/didim-log-be

      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          source: "./docker-compose.yml"
          target: "/home/${{ secrets.AWS_USER }}/app/didim-log-be"
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}

      - name: Create .env file on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.AWS_USER }}/app/didim-log-be
            # === 데이터베이스 연결 설정 ===
            echo "SPRING_DATA_MONGODB_URI=${{ secrets.SPRING_DATA_MONGODB_URI }}" > .env
            echo "SPRING_DATA_REDIS_HOST=${{ secrets.SPRING_DATA_REDIS_HOST }}" >> .env
            echo "SPRING_DATA_REDIS_PORT=${{ secrets.SPRING_DATA_REDIS_PORT }}" >> .env
            
            # === 서버 설정 ===
            echo "SERVER_URL=${{ secrets.SERVER_URL }}" >> .env
            
            # === JWT 토큰 설정 ===
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            # JWT 토큰 만료 시간 (선택사항, 기본값 사용 시 생략 가능)
            # JWT_ACCESS_TOKEN_EXPIRATION=${JWT_ACCESS_TOKEN_EXPIRATION:-1800000}
            # JWT_REFRESH_TOKEN_EXPIRATION=${JWT_REFRESH_TOKEN_EXPIRATION:-604800000}
            # JWT_EXPIRATION=${JWT_EXPIRATION:-1800000}
            
            # === CORS 설정 ===
            echo "ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}" >> .env
            # 하위 호환(legacy): 기존 키를 사용하는 경우를 대비
            echo "CORS_ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}" >> .env
            
            # === OAuth2 설정 ===
            echo "OAUTH_GOOGLE_ID=${{ secrets.OAUTH_GOOGLE_ID }}" >> .env
            echo "OAUTH_GOOGLE_SECRET=${{ secrets.OAUTH_GOOGLE_SECRET }}" >> .env
            echo "OAUTH_GITHUB_ID=${{ secrets.OAUTH_GITHUB_ID }}" >> .env
            echo "OAUTH_GITHUB_SECRET=${{ secrets.OAUTH_GITHUB_SECRET }}" >> .env
            echo "OAUTH_NAVER_ID=${{ secrets.OAUTH_NAVER_ID }}" >> .env
            echo "OAUTH_NAVER_SECRET=${{ secrets.OAUTH_NAVER_SECRET }}" >> .env
            echo "OAUTH_REDIRECT_URI=${{ secrets.OAUTH_REDIRECT_URI }}" >> .env
            
            # === 관리자 설정 ===
            echo "ADMIN_SECRET_KEY=${{ secrets.ADMIN_SECRET_KEY }}" >> .env
            
            # === 이메일 발송 설정 ===
            echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
            
            # === Swagger UI 설정 ===
            echo "SWAGGER_USERNAME=${{ secrets.SWAGGER_USERNAME }}" >> .env
            echo "SWAGGER_PASSWORD=${{ secrets.SWAGGER_PASSWORD }}" >> .env
            
            # === AI 서비스 설정 (선택사항) ===
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "GEMINI_API_URL=${{ secrets.GEMINI_API_URL }}" >> .env
            # AI_ENABLED=${AI_ENABLED:-false}
            # RETROSPECTIVE_RETENTION_DAYS=${RETROSPECTIVE_RETENTION_DAYS:-180}

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        id: deploy
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.AWS_USER }}/app/didim-log-be
            sudo docker-compose pull
            sudo docker-compose up -d --force-recreate
            sudo docker image prune -a -f

# Secrets 체크리스트 (배포 전 확인):
# === 필수 Secrets ===
# ✅ DOCKER_USERNAME, DOCKER_PASSWORD, DOCKER_REPONAME
# ✅ AWS_HOST, AWS_USER, AWS_EC2_PRIVATE_KEY
# ✅ SPRING_DATA_MONGODB_URI, SPRING_DATA_REDIS_HOST, SPRING_DATA_REDIS_PORT
# ✅ SERVER_URL
# ✅ JWT_SECRET
# ✅ ALLOWED_ORIGINS
# ✅ OAUTH_GOOGLE_ID, OAUTH_GOOGLE_SECRET
# ✅ OAUTH_GITHUB_ID, OAUTH_GITHUB_SECRET
# ✅ OAUTH_NAVER_ID, OAUTH_NAVER_SECRET
# ✅ OAUTH_REDIRECT_URI
# ✅ ADMIN_SECRET_KEY
# ✅ MAIL_USERNAME, MAIL_PASSWORD
# ✅ SWAGGER_USERNAME, SWAGGER_PASSWORD
# === 선택사항 Secrets ===
# ⚪ GEMINI_API_KEY, GEMINI_API_URL (AI 서비스 사용 시)
