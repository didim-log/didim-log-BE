name: didim-log-be Deploy CICD

# Required GitHub Secrets:
# - DOCKER_USERNAME: Docker Hub 사용자명
# - DOCKER_PASSWORD: Docker Hub 비밀번호
# - DOCKER_REPONAME: Docker Hub 저장소 이름
# - AWS_HOST: EC2 인스턴스 호스트 주소
# - AWS_USER: EC2 SSH 사용자명
# - AWS_EC2_PRIVATE_KEY: EC2 SSH 개인 키
# - SPRING_DATA_MONGODB_URI: MongoDB 연결 URI
# - SPRING_DATA_REDIS_HOST: Redis 호스트 (docker-compose service name: 'redis')
# - SPRING_DATA_REDIS_PORT: Redis 포트
# - JWT_SECRET: JWT 토큰 서명용 시크릿 키

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'DOCS/**'
      - 'SECRET_DOCS/**'
      - '.gitignore'
      - '.cursorrules'
      - '*.md'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build with Gradle Wrapper
        run: ./gradlew clean build -x test

      - name: Build Dockerfile and Push DockerHub
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker build -f Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPONAME }}:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPONAME }}:latest

      - name: Create deployment directory on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          script: |
            mkdir -p /home/${{ secrets.AWS_USER }}/app/didim-log-be

      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          source: "./docker-compose.yml"
          target: "/home/${{ secrets.AWS_USER }}/app/didim-log-be"
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}

      - name: Create .env file on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.AWS_USER }}/app/didim-log-be
            echo "SPRING_DATA_MONGODB_URI=${{ secrets.SPRING_DATA_MONGODB_URI }}" > .env
            echo "SPRING_DATA_REDIS_HOST=${{ secrets.SPRING_DATA_REDIS_HOST }}" >> .env
            echo "SPRING_DATA_REDIS_PORT=${{ secrets.SPRING_DATA_REDIS_PORT }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        id: deploy
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_EC2_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.AWS_USER }}/app/didim-log-be
            sudo docker-compose pull
            sudo docker-compose up -d --force-recreate
            sudo docker image prune -a -f
